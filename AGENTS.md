# AGENTS.md（このディレクトリ配下すべてに適用）

このリポジトリは「貼り付けた長文を、ブラウザ内TTSのみで日本語読み上げ」するシングルページWebアプリです。実装・検証は常に `plans.md` を単一の真実源（SSOT）として進めます。本書はエージェント向けの実務ガイドです。

## 基本方針
- SSOT: 仕様・マイルストーン・タスクは `plans.md` に集約し、作業前後に更新する。
- 100%ローカル: サーバ処理・外部TTS・データ送信は行わない。保存も既定で行わない。
- 小さく安全に: 小さなPR/パッチで段階的に。不要な依存を避ける。
- コード生成より責務分割: 分割器/プレイヤ/音声/UI/設定に明確分離。
- 原則コミット不可: 要求がない限り `git commit` は行わない（CLI方針に準拠）。

## 対象ブラウザと前提
- Chrome/Edge 最新、Safari 16+（iOS含む）。`speechSynthesis` が必須。
- iOSは初回操作が必要。バックグラウンド遷移時は自動一時停止の挙動を尊重。

## ディレクトリ方針（新規作成時）
- `index.html` … 単一ページ。コントロール/ペースト領域/ヘルプ。
- `styles.css` … ライト/ダーク、可読性重視。高コントラスト。
- `src/app.ts` … 初期化、イベント配線、キーバインド。
- `src/segmentation/japanese.ts` … 文/短文チャンク分割と簡易正規化。
- `src/tts/engine.ts` … SpeechSynthesis ラッパ、速度/ピッチ/音量/voice適用。
- `src/player/queue.ts` … 再生/一時停止/再開/停止、前後移動、リトライ。
- `src/voices/detect.ts` … 日本語 voice 検出と既定候補の選択。
- `src/ui/highlight.ts` … 現在チャンクのハイライトと自動スクロール。
- `src/ui/state.ts` … UI状態・設定の保持（localStorageは同意時のみ）。

## 進め方（Run the Plans）
1) `plans.md` を読む → 当該フェーズ（M1/M2/M3）を確認。
2) `plans.md` に「Exec Plan: <短いタイトル>」を追記（目的/実施項目/注意/To-Do）。
3) パッチ適用で最小実装 → 直後に簡易動作確認（ブラウザで手動）。
4) 単体テスト（分割器/キュー）やモック統合テストを作成・実行（任意）。
5) `plans.md` の Test/Notes/Known issues を更新。

## セットアップ指針（任意・最小依存）
- Node.js 18+ を想定。ビルド不要方針が基本。必要時のみ Vite を導入可。
- 推奨スクリプト（導入した場合）:
  - `npm run dev` … ローカルプレビュー
  - `npm run build` … 静的出力
  - `npm test` … 単体テスト（Vitest 等）。

## コーディング規約（抜粋）
- TypeScript/ES Modules。strict。top-level await は不可。
- 例外はUIに明示表示し、アプリが停止しないようにする。
- テキスト処理は副作用なしの純関数を優先（テスト容易性）。
- DOM操作は UI 層に限定。ビジネスロジック層にDOMを持ち込まない。
- ファイルは UTF-8、LF。コメントは必要最小限の日本語で要点のみ。

## テスト方針（実務）
- 単体: `japanese.ts` の区切り/最大長、簡易正規化、`queue.ts` の状態遷移。
- 統合モック: `globalThis.speechSynthesis` を簡易モック化し、再生/停止/速度変更/リトライを検証。
- 受け入れ（手動）: `plans.md` の DoD/受け入れテストを満たすこと。主要ブラウザで確認。

## アクセシビリティ/操作
- 既定キーバインド: Space=再生/一時停止, `[`/`]`=前/次, `+`/`-`=速度。
- ARIA/フォーカスリング/コントラスト 4.5:1 以上。

## 既知の制約と対処
- `onboundary` 非対応や不安定環境では文チャンク単位でハイライト同期。
- 日本語 voice が無い環境は警告表示。フォールバックは利用者選択（既定は停止）。
- 長文は 150–300 文字のチャンク連結で安定化。失敗時は自動再キュー。

## Exec Plan テンプレート（`plans.md` に貼付）
```markdown
# Exec Plan: <機能名の要約>

## 目的
<達成したい価値/ユーザー影響を1-2行>

## 実施項目
- [ ] 仕様/UIの確定
- [ ] 実装（ファイル/関数名を明記）
- [ ] 単体/統合（モック）テスト
- [ ] 受け入れ手順の追記

## 注意/リスク
- <ブラウザ差異やTTS制約>

## To-Do
1. [ ] …
```

## 完了条件（DoD再掲）
- 貼り付け→分割→連続再生、日本語 voice 選択、速度/ピッチ/音量の変更が可能。
- 文ハイライトと自動スクロールが同期する。失敗時は自動リトライ。
- 端末外通信なし。主要ブラウザで同等に利用可能（差異はUI明示）。

以上。エージェントは本書と `plans.md` を常に同期し、段階的に実装を進めてください。
