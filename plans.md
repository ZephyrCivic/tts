# Yomiage Web TTS（日本語特化）— Plans

最終更新日: 2025-10-28

この計画書は、ブラウザ組み込みの TTS（Web Speech API: SpeechSynthesis）だけを用い、貼り付けた大規模テキストを端末内で音声読み上げするシングルページ Web アプリ（サーバ不要・ファイル保存なし）の設計と実装計画を示します。日本語文書（ビジネス文書中心）に最適化し、途中停止・再開、再生速度変更、音声/ピッチ/音量の調整、文単位ハイライト、キーボード操作に対応します。

**目的**
- 長文の業務文書（議事録、企画書、契約関連、レポート等）を「耳で読む」体験を高品質に提供する。
- データは端末外に出さない（プライバシー保護）。
- 面倒なく貼り付けてすぐ聴ける。

**スコープ**
- 入力: Webページへの貼り付け（ペースト）と直接入力。オプションでドラッグ&ドロップのテキスト取込み（アップロードせずメモリ内処理）。
- 出力: デバイス内 TTS 再生のみ。音声ファイルの生成・保存は行わない。
- 日本語に特化（英数字・記号の読み上げ最適化も含む）。

**非スコープ**
- サーバ側処理／クラウドTTS／アカウント機能／共有。
- 外部依存の辞書連携（将来拡張の余地は記載）。

---

**DoD（完了の定義）**
- ブラウザ上で貼り付けた長文を、日本語音声で連続再生できる。
- 再生/一時停止/再開/停止、再生速度・ピッチ・音量変更が動作する（変更は即時に反映）。
- 読み上げ対象文のハイライトと自動スクロールが機能する。
- 音声（voice）の日本語候補を列挙・選択でき、選択が継続反映される。
- 大規模テキスト（目安: 30〜200k文字）でもフリーズせず分割再生できる。
- すべて端末内で完結（ネットワーク不要）。
- キーボード操作が可能（例: Space=再生/一時停止, ←/→=文単位移動, +/-=速度）。
- 主要ブラウザ（Chrome/Edge、Safari）で使える制約・既知差異を表示し、代替挙動を実装。

---

**非機能要件**
- プライバシー: テキストは端末外に送信しない。保存もしない（既定）。
- パフォーマンス: 初期表示 < 1s（二回目以降のロード時）。貼り付け〜再生開始 < 500ms（1万文字時、端末中級スペック想定）。
- 信頼性: 途中での TTS 失敗時は自動リトライし、文単位の再開が可能。
- 対応ブラウザ: Chrome/Edge 最新、Safari 16+（iOS含む）の範囲で検証し、差分はUIに注記。
- アクセシビリティ: キーボード操作、コントラスト/フォーカス可視、スクリーンリーダーに配慮。

---

**主要リスクと対策**
- 音声エンジン差異: Voice名や `onboundary` 仕様がブラウザで異なる → 句点単位の内部区切りでハイライトを実装（`onend`でフォールバック）。
- 長文の読み飛ばし/停止: 1文〜短文チャンク（目安150–300文字）に分割しキュー再生。失敗時は当該チャンクを再キュー。
- iOSの自動再生制限: 初回は必ずユーザー操作で開始。バックグラウンド遷移時の一時停止に対応。
- 日本語音声の未提供環境: 代替のローカル音声を案内し、非対応時は注意表示＋英語音声に最後の手段でフォールバック（既定は停止）。

---

**設計方針**
- 100%ローカル: 静的配布（`index.html` + `*.js/css`）。サービスワーカーは任意（オフライン強化）。
- 技術選定: フレームワーク非依存（素の TypeScript + 小粒なUIヘルパ）。ビルドは Vite など最小限。依存はゼロ〜極小。
- モジュール分割: 「分割器」「キュー/プレイヤ」「音声管理」「UI状態」「設定」「ハイライト」へ責務分離。
- 可搬性: CSSはシンプル（System UIフォント + ダーク/ライト）。
- 永続化: 既定は無効。ユーザー同意時のみ `localStorage` に設定（速度/音声/ピッチ）を保存可。

---

**アーキテクチャ（提案）**
- `src/segmentation/japanese.ts`: 日本語テキスト分割（文/短文チャンク）。句点「。」「！」「？」、読点「、」、改行、箇条書き（・, -, ① 等）に対応。最大長を守る統合器を持つ。
- `src/tts/engine.ts`: `speechSynthesis` ラッパ。`SpeechSynthesisUtterance` の生成、イベント購読（`onend/onerror/onboundary`）。速度/ピッチ/音量/voice の適用。
- `src/player/queue.ts`: チャンクのキュー管理。再生/一時停止/再開/停止、次/前、失敗時のリトライ、現在インデックス管理。
- `src/voices/detect.ts`: 日本語 voice の列挙・最適候補の選定（`ja`, `ja-JP` を優先、`name` と `lang` でフィルタ）。`voiceschanged` イベント待機。
- `src/ui/state.ts`: UI 状態（再生中/停止/現在文、設定、統計）。
- `src/ui/components/*`: コントロール群（貼り付けエリア、再生バー、速度/ピッチ/音量、voice セレクタ、進捗/残り時間表示）。
- `src/app.ts`: 初期化、イベント配線、キーバインド、例外ハンドリング、ユーザー操作トリガの確保。
- `index.html`: 1ページ構成。視覚的ハイライト用の軽量CSS。

---

**日本語向け分割仕様（初期案）**
- 文区切り: 「。」「！」「？」（全角/半角）。括弧閉じ（）」】］）直後の句点は同一文に含める。末尾の引用符「」は文に含める。
- 読点/改行: 読点「、」や中点「・」が連続する場合は 150–300 文字を上限に短文チャンク化。
- 箇条書き: 行頭の「- 」「・」「* 」「①」「(1)」「1.」などを検出し、項目単位でチャンク。
- 記号の正規化: 連続スペース/罫線/装飾記号を縮約。「(株)」「No.」「Ver.」「約10%」などの読み誤りを軽減する簡易置換ルールを適用（例: ％→パーセント、No.→ナンバー）。
- 数値・単位: `1000円`→`1000 えん`、`23%`→`23 パーセント` など軽量規則で補正（過度な形態素解析は行わない）。
- 最大長: 1チャンク 150–300 文字（ブラウザ差異を吸収）。句点越えの連結はしない。

---

**プレイヤー仕様**
- コントロール: 再生/一時停止/停止/前へ/次へ、速度(0.5–2.0, step 0.05)、ピッチ(0.5–2.0)、音量(0–1)。
- 反映タイミング: 再生中の速度・ピッチ変更は次チャンクから反映。オプションで「即時反映（現 utterance をキャンセル→再キュー）」を選択可。
- 進捗: 現在チャンク番号/総数、推定残り時間（速度から算出）。
- ハイライト: 現在チャンク背景を強調し、再生に合わせて自動スクロール。`onboundary` 対応時は語単位の下線を追加。
- エラー時: チャンク単位で最大2回まで自動リトライし、失敗時はスキップしてログ表示（UIバナー）。

---

**UI/UX**
- ペーストエリア: 大きめ文字、行数自動拡張。貼り付け時に軽量前処理（不可視制御文字の除去等）。
- コントロールバー: 大きめの再生系ボタン、速度/ピッチ/音量のスライダ、音声選択ドロップダウン。
- ステータス: 「日本語音声が見つかりません」等の明示。ブラウザ差異の案内リンク（ローカルのヘルプ）。
- キーボード: Space=再生/一時停止, `[`/`]`=前/次, `+`/`-`=速度, `P`=ピッチ, `M`=音量ミュート。
- テーマ: ライト/ダーク自動。コントラスト比 4.5:1 以上。

---

**テスト方針**
- 単体: 分割器（句読点/箇条書き/最大長）・正規化ルール・キュー境界の動作。
- 統合（モック）: `speechSynthesis` をモック化し、再生フロー/一時停止/速度変更/リトライを検証。
- E2E（ヘッドレス）: ペースト→再生→停止→速度変更→次/前→ハイライトの視覚確認（スクショ比較）。
- 手動マトリクス: Chrome/Edge/Safari、Windows/macOS/iOS での voice 有無・制限確認。

---

**マイルストーン**
1) M1: MVP（貼り付け→分割→再生/一時停止/再開）
- 分割器（文/短文）とキュー実装、基本UI、速度変更（次チャンク適用）。
- 日本語 voice 自動選定（見つからない場合の明示）。

2) M2: 操作性/可視化強化
- 現在文ハイライト・自動スクロール、キーボード操作、残り時間推定、設定UI。

3) M3: 品質仕上げ/互換性/オフライン
- Safari差分の調整、失敗時リトライ、軽量ヘルプ、PWA（任意）。

---

**タスク分解（実行順）**
0. プロジェクト雛形
- `index.html`/`styles.css`/`src/app.ts` の最小構成。型定義とリンタ導入（任意）。

1. 日本語分割器の実装 `src/segmentation/japanese.ts`
- 文抽出の正規表現、箇条書き検出、最大長分割。単体テスト作成。

2. TTSエンジンの薄いラッパ `src/tts/engine.ts`
- utterance生成、速度/ピッチ/音量、イベント束ね、キャンセル/再開。

3. 再生キュー `src/player/queue.ts`
- 再生/一時停止/再開/停止、前/次、現在インデックス、リトライ機構。

4. 基本UIと配線 `src/app.ts`, `src/ui/*`
- ペースト→分割→再生。ボタン/スライダ/セレクタの双方向バインド。Spaceでトグル。

5. ハイライト/自動スクロール `src/ui/highlight.ts`
- 現在チャンクの DOM 範囲計算とスクロール。`onboundary` 対応なら語単位オプション。

6. 日本語 voice 検出 `src/voices/detect.ts`
- `voiceschanged` 待機、`lang` に `ja` を含むものを優先。未検出時の警告UI。

7. エラーハンドリング/リカバリ
- 失敗時の自動スキップ/リトライ、ユーザー通知、状態整合性の保証。

8. キーボード操作/設定の保存（任意）
- キーバインド実装。ユーザー同意時のみ `localStorage` に速度/voice を保存。

9. 互換性/パフォーマンス調整
- iOSの操作要件（初回操作必須）対応、チャンク長の動的最適化（失敗率に応じ調整）。

10. 仕上げ/ヘルプ/軽いPWA（任意）
- 既知の制約ページ、簡易PWA（アイコンとオフラインキャッシュ）。

---

**受け入れテスト（抜粋）**
- 10万文字の貼り付けで、分割時間 < 3秒、再生開始 < 1秒。
- 速度 0.8→1.2→1.8 変更で、次チャンクから確実に反映。
- 「次」操作で前後文へ確実に遷移し、ハイライトが追従。
- Safari で初回ユーザー操作後に再生が開始し、バックグラウンド復帰時に自動再開しない（明示仕様）。
- 日本語 voice が一つも無い場合に、UI が理由と回避策を表示。

---

**既知の制約/注意**
- `onboundary` が常に語境界を提供するとは限らない。最低限、文チャンク境界でハイライトを同期。
- 長大な1文（例: 2000文字超）は分割の上限により途中で切る。文意の損失を避けるため、句読点や読点で安全に切る。
- 極端な数式/表は読み上げが不自然になり得る。軽量正規化で妥協。

---

**将来拡張の候補**
- ユーザー辞書（社内用語の読み替え）。
- 用語強調読み（特定語の速度/ピッチ変更）。
- 選択範囲のみのループ再生、ブックマーク（セッション内に限定）。

---

**実装開始のチェックリスト**
- [ ] ブラウザで `speechSynthesis` 可用性チェックと案内UI。
- [ ] 分割器の単体テスト充足（句点/箇条/最大長）。
- [ ] 再生キューの状態遷移図（Playing/Paused/Stopped/Ended/Error）。
- [ ] 主要キーバインドの衝突確認（スクリーンリーダー配慮）。
- [ ] Safari/iOS の初回操作要件のE2E確認。

以上のPlansに沿って、M1→M3の順で実装・検証を進めれば、本プロジェクトの目的（ビジネス文書の高品質な耳読体験）をファイル保存なし・端末内完結で達成できます。


# Exec Plan: Shadcn UI モバイル最適化

## 目的
既存UIをShadcn/UIベースへ刷新し、コンポーネント設計とモバイル最適化を両立させて操作性・視認性を高める。

## 実施項目
- [x] 仕様/UIの確定
- [x] 実装（React/Vite/Tailwind構成および主要コンポーネント）
- [ ] 単体/統合（モック）テスト
- [x] 受け入れ手順の追記

## 注意/リスク
- Shadcn/UI導入に伴う依存追加とビルド/バンドル構成変更
- 既存の音声キュー機構・分割器ロジックの互換維持とイベント配線の移行
- モバイル端末でのタッチ操作・フォーカスリングの確保

## To-Do
1. [x] UIコンポーネント構成（ボタン/スライダー/タブ等）のマッピング
2. [x] Vite + Tailwind + Shadcnのセットアップとビルド確認
3. [x] 既存機能のReactコンポーネント化と動作検証
4. [x] モバイル向けレイアウト・アクセシビリティ最適化

### Test（2025-10-28）
- `npm run build` でViteビルドを確認（自動テストは未整備）。

### Notes
- UIをShadcn/UIベースに刷新し、React + Tailwind構成へ全面移行。
- 既存の分割・再生ロジックはTypeScript化して再利用し、モバイル向けにレイアウトを再設計。
- GitHub Pages での配信は `npm run build:pages` 実行後に `docs/` を公開する想定。

# Exec Plan: 再生品質とUI改善

## 目的
速度調整と進行管理を使いやすくし、読み上げ品質を向上させることで業務利用時の操作ストレスを低減する。

## 実施項目
- [x] UI調整（ピッチ削除、速度スライダー見直し、進捗バー追加）
- [x] 再生キュー改善（速度変更時の続き再生、境界オフセット管理）
- [x] セグメンテーション/再生品質の検証と調整
- [x] 受け入れ手順・ドキュメント更新

## 注意/リスク
- `onboundary` 非対応環境では続き再生が困難なためフォールバック動作を明示する。
- 進捗バーのシーク操作でハイライトと再生位置の同期ずれが起きないようにする。
- 操作中の速度変更が多発する場合の SpeechSynthesis 安定性を監視する。

## To-Do
1. [x] 速度UI刷新とピッチ削除デザイン反映
2. [x] PlayerQueueのオフセット再生ロジック実装
3. [x] 進行度バーとシーク操作の追加・検証
4. [x] 動作確認・ドキュメント更新

### Test（2025-10-28）
- `npm run build`
- `npm run build:pages`

### Notes
- `onboundary` が取得できないブラウザでは速度変更が次チャンクから反映される旨をUIで案内。
- シーク操作は再生状態を維持しつつ、停止中は位置のみ変更する実装に統一。

# Exec Plan: M1 雛形 + MVP再生

## 目的
貼り付け→分割→音声再生（再生/一時停止/再開）までを、ビルド不要の静的ファイルで成立させる。

## 実施項目
- [x] 雛形の作成（`index.html`, `styles.css`, `src/*`）
- [x] 日本語分割器の実装（句読点/箇条/最大長）
- [x] TTSエンジン薄ラッパと再生キュー
- [x] 基本UI配線（ボタン/スライダ/セレクタ/キーバインド）
- [x] 日本語voice検出と選択UI
- [x] 文ハイライトと自動スクロール（簡易）
- [ ] 受け入れ手動テスト（Chrome/Edge/Safari）

## 注意/リスク
- Safari/iOS は初回操作が必須。バックグラウンド遷移時に自動停止する。
- `onboundary` が利用できない環境では文チャンク単位で同期。
- 極端に長い文は安全な位置で分割し、読みの不自然さを最小化。

## To-Do
1. [ ] Safari（macOS/iOS）での挙動確認と既知差異の注記更新
2. [ ] 速度・ピッチの「即時反映」オプションの可否検討
3. [ ] 既知の略語（No., Ver., ％ など）の正規化ルール拡充

# Exec Plan: Markdown入力対応

## 目的
Markdown形式の文書を貼り付けた場合でも、見やすいプレビュー表示と自然な読み上げを両立させる。

## 実施項目
- [x] 表示モード（テキスト/Markdown）のUI設計
- [x] Markdown→テキスト/HTML変換ユーティリティの実装
- [x] モード切替に応じた分割・再生処理とプレビュー更新
- [ ] 手動受け入れテスト手順の追加/更新

## 注意/リスク
- MarkdownのHTML化ではユーザー入力をサニタイズし、XSSを防ぐ。
- チャンクハイライトとMarkdownプレビューの整合が取りづらい点を明示し、必要ならテキスト表示に切替できるようにする。

## To-Do
1. [ ] UIモード切替時のショートカット/キーボード操作確認
2. [ ] Markdownサンプル文書での長文パフォーマンス計測
3. [ ] SafariでのMarkdownプレビュー表示互換性確認
# Exec Plan: 再生速度即時変更

## 目的
再生中でも速度変更を即時反映し、不要となった音量調整UIを整理して操作を簡素化する。

## 実施項目
- [x] 仕様/UIの確定（速度は即時反映、音量UI削除）
- [x] 実装（`src/player/queue.js`, `src/app.js`, `index.html`, `styles.css` の更新）
- [ ] 単体/統合（モック）テスト
- [x] 受け入れ手順の追記

## 注意/リスク
- `speechSynthesis.cancel()` 呼び出し時の `onend` 挙動差異でチャンクが飛ぶ可能性。

## To-Do
1. [ ] 即時再生のブラウザ挙動を確認（Chrome/Edge/Safari）
2. [x] ヘルプ文言を最新仕様へ更新

# Exec Plan: 音質調整と停止挙動の改善

## 目的
速度変更時の聞き取りにくさや停止操作の不安定さを解消し、Google 日本語 voice に最適化した体験を提供する。

## 実施項目
- [x] 停止ボタンの挙動見直し（発話イベントのキャンセル/クリーンアップ）
- [x] Google 日本語 voice の優先選択ロジック実装
- [x] 速度に応じた自動ピッチ補正と聴感品質の検証
- [x] ドキュメント更新（音質方針・既知の制約追記）

## 注意/リスク
- speechSynthesis はブラウザ/OS の実装差異が大きく、環境によっては boundary イベントが取得できない。
- Google 日本語 voice が存在しない環境では従来通りのフォールバックを維持する必要がある。
- ピッチ補正が極端になると逆に不自然になるため、適用範囲を限定する。

## To-Do
1. [x] PlayerQueue 停止処理の安定化
2. [x] Google 日本語 voice 優先/限定ロジック
3. [x] 速度連動ピッチ補正の実装と微調整
4. [x] README / UI メッセージ更新

### Test（2025-10-28）
- `npm run build`
- `npm run build:pages`

### Notes
- 停止ボタンで即時に再生が終了するよう Utterance のイベントをクリーンアップ。
- Google 日本語 voice を優先し、存在しない場合は自動でフォールバックするメッセージを表示。
- 速度に応じてピッチを動的調整し、高速読み上げ時の聞き取りにくさを緩和。
- 音量スライダーを追加し、PlayerQueue に volume を伝搬させて再生中でも反映。
- README に音質調整と公開手順、既知の制約を追記。
